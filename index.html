<!DOCTYPE html>
<html>
<head>
    <title>Live Face Match</title>
    <!-- Include the CompreFace SDK from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@exadel/compreface-js-sdk@0.7.1/dist/compreface-js-sdk.min.js"></script>
</head>
<body>
    <h1>Live Face Recognition</h1>
    <video id="webcam" autoplay muted width="640" height="480"></video>
    <p id="result">Result: Waiting...</p>

    <script>
        // Use the code from your query
        const url = "https://shaniqua-unimparted-subarticulately.ngrok-free.dev"; // Use HTTPS Ngrok URL
        const port = 443; // Ngrok HTTPS uses port 443
        const api_key = "df0463f7-57a6-4e72-9fae-7ea2c5a32e37";

        const { CompreFace } = window.compreface_js_sdk;
        const compreFace = new CompreFace(url, port);
        const recognitionService = compreFace.initFaceRecognitionService(api_key);

        // Start the webcam
        async function startWebcam() {
            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            // Take a frame every 3 seconds to test
            setInterval(async () => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                // Convert frame to blob and send to your GCP instance
                canvas.toBlob((blob) => {
                    recognitionService.recognize(blob)
                        .then(res => {
                            document.getElementById('result').innerText = "Match: " + JSON.stringify(res.result[0].subjects[0].subject);
                        })
                        .catch(err => console.log("Recognition error:", err));
                }, 'image/jpeg');
            }, 3000);
        }

        startWebcam();
    </script>
</body>
</html>
