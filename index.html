<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Face Match</title>
</head>
<body style="font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f9;">
    <h1>Live Face Recognition</h1>
    
    <!-- Video Preview -->
    <div style="margin-top: 20px;">
        <video id="webcam" autoplay muted width="640" height="480" style="border: 2px solid #333; border-radius: 10px; background-color: #000;"></video>
    </div>

    <!-- Status and Results -->
    <div style="margin-top: 20px;">
        <p id="result" style="font-weight: bold; font-size: 1.4em; color: #555;">Status: Initializing...</p>
        <p id="details" style="color: #888;">Live feed scanning every 3 seconds...</p>
    </div>

    <script>
        window.onload = async function() {
            /** 
             * 1. CONFIGURATION 
             * Replace the URL with your current Ngrok HTTPS address.
             * Replace the API Key with your Recognition Service key.
             */
            const ngrokUrl = "https://shaniqua-unimparted-subarticulately.ngrok-free.dev";
            const apiKey = "df0463f7-57a6-4e72-9fae-7ea2c5a32e37";
            
            // ?limit=1 is mandatory for recognition to prevent 400 errors
            const apiEndpoint = `${ngrokUrl}/api/v1/recognition/recognize?limit=1`;

            const video = document.getElementById('webcam');
            const resultText = document.getElementById('result');

            async function startWebcam() {
                try {
                    // 2. Start the Camera
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "user" } 
                    });
                    video.srcObject = stream;
                    resultText.innerText = "Status: Scanning for faces...";

                    // 3. Capture and Send a frame every 3 seconds
                    setInterval(async () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);

                        canvas.toBlob(async (blob) => {
                            if (!blob) return;

                            // 4. PREPARE THE DATA
                            const formData = new FormData();
                            // Field name MUST be 'file'. Filename helps with server validation.
                            formData.append('file', blob, 'capture.jpg');

                            try {
                                // 5. SEND TO CLOUD
                                const response = await fetch(apiEndpoint, {
                                    method: 'POST',
                                    headers: {
                                        'x-api-key': apiKey
                                        // DO NOT add Content-Type: multipart/form-data. 
                                        // The browser must set it to include the unique boundary string.
                                    },
                                    body: formData
                                });

                                const data = await response.json();

                                if (data.result && data.result.length > 0 && data.result[0].subjects.length > 0) {
                                    const match = data.result[0].subjects[0];
                                    const name = match.subject;
                                    const confidence = (match.similarity * 100).toFixed(1);
                                    
                                    resultText.innerText = `MATCH FOUND: ${name} (${confidence}%)`;
                                    resultText.style.color = "#2e7d32"; // Success Green
                                } else {
                                    resultText.innerText = "Scanning... No match found.";
                                    resultText.style.color = "#555";
                                }
                            } catch (err) {
                                console.error("Network Error:", err);
                                resultText.innerText = "Connection Error: Is Ngrok still active?";
                                resultText.style.color = "#c62828"; // Error Red
                            }
                        }, 'image/jpeg', 0.85); // Compress slightly for faster cloud transfer
                    }, 3000);

                } catch (err) {
                    resultText.innerText = "Camera Access Denied: Check browser permissions.";
                    resultText.style.color = "#c62828";
                    console.error("Camera Error:", err);
                }
            }

            startWebcam();
        };
    </script>
</body>
</html>
